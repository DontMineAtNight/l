<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>TFD Automation</title>
    <link rel="stylesheet" href="app://assets/css/style.css">
    <link rel="stylesheet" href="app://assets/css/tailwind.css">
    <link rel="stylesheet" href="app://assets/css/plugin-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-yellow: #eab308;
            --accent-purple: #a855f7;
            --bg-card: rgba(30, 30, 35, 0.9);
            --bg-card-hover: rgba(40, 40, 48, 0.95);
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-accent: rgba(139, 92, 246, 0.4);
        }

        /* Animations */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px var(--accent-purple); } 50% { box-shadow: 0 0 20px var(--accent-purple); } }

        /* Layout */
        .main-grid {
            display: grid;
            gap: 1rem;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.2s ease;
        }
        .card:hover { background: var(--bg-card-hover); }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-subtle);
        }
        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #e5e5e5;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .card-title i { font-size: 0.75rem; opacity: 0.7; }

        /* Control Panel */
        .control-panel {
            background: linear-gradient(135deg, rgba(30, 30, 35, 0.95), rgba(25, 25, 30, 0.95));
            border: 1px solid var(--border-accent);
            padding: 1.25rem;
        }
        .control-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-start { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .btn-start:hover:not(:disabled) { background: linear-gradient(135deg, #16a34a, #15803d); transform: translateY(-1px); }
        .btn-stop { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-stop:hover:not(:disabled) { background: linear-gradient(135deg, #dc2626, #b91c1c); transform: translateY(-1px); }
        .btn-reset { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .btn-reset:hover:not(:disabled) { background: linear-gradient(135deg, #4f46e5, #4338ca); transform: translateY(-1px); }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--border-subtle);
        }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.12); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }
        .stat-item {
            text-align: center;
            padding: 0.75rem 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
        }
        .stat-value.success { color: var(--accent-green); }
        .stat-value.failed { color: var(--accent-red); }
        .stat-value.skipped { color: var(--accent-yellow); }
        .stat-value.total { color: var(--accent-blue); }
        .stat-label {
            font-size: 0.7rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        /* Status Section */
        .status-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 0.75rem;
        }
        .status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6b7280;
        }
        .status-dot.running { background: var(--accent-green); animation: pulse 1.5s infinite; }
        .status-dot.error { background: var(--accent-red); }
        .status-dot.warning { background: var(--accent-yellow); }
        .status-message {
            font-size: 0.8rem;
            color: #d1d5db;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            margin-top: 0.5rem;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 0.75rem;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 0.375rem;
            color: #9ca3af;
        }
        .progress-track {
            height: 6px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Collapsible Sections */
        .collapse-trigger {
            cursor: pointer;
            user-select: none;
            transition: opacity 0.2s;
        }
        .collapse-trigger:hover { opacity: 0.8; }
        .collapse-chevron {
            transition: transform 0.2s ease;
            font-size: 0.7rem;
        }
        .collapse-chevron.collapsed { transform: rotate(-90deg); }
        .collapsible-content {
            overflow: hidden;
            max-height: 2000px;
            opacity: 1;
            transition: all 0.3s ease;
        }
        .collapsible-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        .setting-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #d1d5db;
        }
        .setting-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-purple);
        }
        .setting-item select,
        .setting-item input[type="number"] {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            color: #e5e5e5;
            font-size: 0.75rem;
            min-width: 80px;
        }

        /* Filter Section */
        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        .filter-field label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: #d1d5db;
            margin-bottom: 0.375rem;
        }
        .filter-field .hint {
            font-size: 0.65rem;
            color: #6b7280;
            font-weight: 400;
        }
        .filter-field textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 0.5rem;
            color: #e5e5e5;
            font-size: 0.75rem;
            font-family: 'SF Mono', monospace;
            resize: vertical;
            min-height: 60px;
        }
        .filter-status {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 0.75rem;
        }
        .filter-buttons .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Item Log */
        .item-log-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }
        .log-actions {
            display: flex;
            gap: 0.375rem;
        }
        .log-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }
        .search-box {
            position: relative;
            margin-bottom: 0.5rem;
        }
        .search-box input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 0.5rem 0.5rem 0.5rem 2rem;
            color: #e5e5e5;
            font-size: 0.8rem;
        }
        .search-box i {
            position: absolute;
            left: 0.625rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 0.75rem;
        }
        .item-log {
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .item-log.collapsed { max-height: 120px; }
        .item-log-empty {
            text-align: center;
            color: #6b7280;
            font-size: 0.8rem;
            padding: 1rem;
        }

        /* Modal */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: linear-gradient(135deg, rgba(30, 30, 35, 0.98), rgba(40, 40, 48, 0.98));
            border: 1px solid var(--border-accent);
            border-radius: 16px;
            backdrop-filter: blur(20px);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }
    </style>
</head>
<body class="bg-primary-bg text-text-primary h-screen flex flex-col overflow-hidden">

    <!-- Draggable Header -->
    <div class="jam-plugin-header">
        <span class="jam-plugin-title">TFD Automation</span>
        <div class="jam-plugin-controls">
            <button class="jam-plugin-minimize" aria-label="Minimize">
                <i class="fas fa-minus"></i>
            </button>
            <button class="jam-plugin-close" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Educational Modal -->
    <div id="educationalModal" class="modal-overlay fixed inset-0 z-50 flex items-start justify-center p-4 overflow-y-auto hidden">
        <div class="modal-content w-full max-w-[550px] max-h-[85vh] my-4 overflow-hidden flex flex-col">
            <div class="p-5 flex-shrink-0">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-bold text-purple-400">
                        <i class="fas fa-graduation-cap mr-2"></i>TFD Automation Guide
                    </h2>
                    <button id="closeModal" class="text-gray-400 hover:text-white transition-colors p-1">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="px-5 pb-5 flex-1 overflow-y-auto">
                <div class="space-y-3 text-sm">
                    <div class="bg-blue-900/30 border border-blue-500/40 rounded-lg p-3">
                        <h3 class="font-semibold text-blue-300 mb-2 text-sm">
                            <i class="fas fa-info-circle mr-2"></i>How It Works
                        </h3>
                        <ul class="space-y-1 text-blue-200 text-xs">
                            <li>• Items go straight to your inventory</li>
                            <li>• Start in your den for best results</li>
                            <li>• Use filters to auto-recycle unwanted items</li>
                        </ul>
                    </div>
                    <div class="bg-yellow-900/30 border border-yellow-500/40 rounded-lg p-3">
                        <h3 class="font-semibold text-yellow-300 mb-2 text-sm">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Important Notes
                        </h3>
                        <ul class="space-y-1 text-yellow-200 text-xs">
                            <li>• Always be in a room before starting</li>
                            <li>• Don't interact during automation</li>
                            <li>• Skipped runs don't collect rewards</li>
                        </ul>
                    </div>
                    <button id="startAutomationFromModal" class="w-full btn btn-start justify-center mt-3">
                        <i class="fas fa-check"></i> Got it!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="jam-plugin-content p-3 overflow-y-auto flex-1">
        <div class="main-grid">
            
            <!-- Control Panel -->
            <div class="card control-panel">
                <div class="control-buttons">
                    <button id="startButton" class="btn btn-start">
                        <i class="fas fa-play"></i> Start
                    </button>
                    <button id="stopButton" class="btn btn-stop" disabled>
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button id="resetStatsButton" class="btn btn-reset">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <button id="infoButton" class="btn btn-secondary">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Stats & Status Combined -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-chart-bar"></i> Statistics</span>
                    <span id="statusIcon" class="status-indicator">
                        <span class="status-dot"></span>
                        <span>Idle</span>
                    </span>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value success" id="successCount">0</div>
                        <div class="stat-label">Success</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value failed" id="failureCount">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value skipped" id="skippedCount">0</div>
                        <div class="stat-label">Skipped</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value total" id="totalRuns">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>

                <div class="status-section mt-3">
                    <p id="statusMessage" class="status-message">Ready to start TFD automation</p>
                    <div class="progress-container">
                        <div class="progress-header">
                            <span>Progress</span>
                            <span id="progressText">0%</span>
                        </div>
                        <div class="progress-track">
                            <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="card">
                <div class="card-header collapse-trigger" id="settingsToggle">
                    <span class="card-title"><i class="fas fa-cog"></i> Settings</span>
                    <i class="fas fa-chevron-down collapse-chevron" id="settingsChevron"></i>
                </div>
                <div class="collapsible-content" id="settingsContent">
                    <div class="settings-grid">
                        <label class="setting-item">
                            <input type="checkbox" id="autoRetryCheckbox" checked>
                            <span>Auto-retry on failure</span>
                        </label>
                        <label class="setting-item">
                            <input type="checkbox" id="soundNotificationCheckbox">
                            <span>Sound notifications</span>
                        </label>
                        <label class="setting-item">
                            <input type="checkbox" id="connectionFailureSoundCheckbox">
                            <span>Connection alerts</span>
                        </label>
                        <label class="setting-item">
                            <input type="checkbox" id="dontLogRecycledCheckbox">
                            <span>Hide recycled items</span>
                        </label>
                        <label class="setting-item">
                            <input type="checkbox" id="efficientModeCheckbox">
                            <span>Efficient mode</span>
                        </label>
                        <div class="setting-item" id="specialModeContainer">
                            <input type="checkbox" id="specialModeCheckbox">
                            <span>Special mode</span>
                        </div>
                    </div>
                    
                    <div class="settings-grid mt-3">
                        <div class="setting-item">
                            <span>Loop:</span>
                            <select id="loopMode">
                                <option value="1">Once</option>
                                <option value="5">5 runs</option>
                                <option value="10">10 runs</option>
                                <option value="infinite">∞ Infinite</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <span>Wait time:</span>
                            <select id="rewardWaitTime">
                                <option value="11:00">11:00 (2m)</option>
                                <option value="12:00">12:00 (3m)</option>
                                <option value="13:00" selected>13:00 (4m)</option>
                                <option value="randomized">Random</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <span>Max retries:</span>
                            <input type="number" id="maxRetries" value="3" min="0" max="10" style="width: 60px;">
                        </div>
                        <div class="setting-item">
                            <span>Target:</span>
                            <select id="targetAccount">
                                <option value="">All Accounts</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item mt-3" id="crystalDelayContainer">
                        <span>Crystal delay (ms):</span>
                        <input type="number" id="crystalDelay" value="10" min="5" max="500" style="width: 70px;">
                    </div>
                </div>
            </div>

            <!-- Item Filters -->
            <div class="card">
                <div class="card-header collapse-trigger" id="filterToggle">
                    <span class="card-title"><i class="fas fa-filter"></i> Item Filters</span>
                    <i class="fas fa-chevron-down collapse-chevron" id="filterChevron"></i>
                </div>
                <div class="collapsible-content" id="filterContent">
                    <div id="filterStatus" class="filter-status">
                        <i class="fas fa-info-circle text-blue-400"></i>
                        <span id="filterStatusText">Disabled (no item IDs specified)</span>
                    </div>
                    
                    <div class="filter-grid">
                        <div class="filter-field">
                            <label>Clothing IDs to Keep <span class="hint">(comma-separated)</span></label>
                            <textarea id="clothingWhitelist" placeholder="e.g., 277, 695"></textarea>
                        </div>
                        <div class="filter-field">
                            <label>Den Item IDs to Keep <span class="hint">(comma-separated)</span></label>
                            <textarea id="denWhitelist" placeholder="e.g., 720, 646"></textarea>
                        </div>
                    </div>
                    
                    <div class="filter-buttons">
                        <button id="saveWhitelistsButton" class="btn btn-secondary">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button id="clearWhitelistsButton" class="btn btn-secondary">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                        <button id="openClothingJson" class="btn btn-secondary">
                            <i class="fas fa-tshirt"></i> Clothing IDs
                        </button>
                        <button id="openDenItemsJson" class="btn btn-secondary">
                            <i class="fas fa-couch"></i> Den IDs
                        </button>
                    </div>
                </div>
            </div>

            <!-- Received Items Log -->
            <div class="card" id="receivedItemsContainer">
                <div class="card-header item-log-header">
                    <span class="card-title"><i class="fas fa-gift"></i> Received Items</span>
                    <div class="log-actions">
                        <button id="toggleLogButton" class="btn btn-secondary" style="display: none;">
                            Show All
                        </button>
                        <button id="clearLogButton" class="btn btn-secondary">
                            <i class="fas fa-trash-alt"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="itemSearchBox" placeholder="Search items...">
                </div>
                <div id="itemLog" class="item-log collapsed">
                    <p class="item-log-empty">No items received yet.</p>
                </div>
            </div>

        </div>
    </div>

    <script src="index.js"></script>
    <script src="app://assets/javascript/plugin-utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializePluginUI();
        });
    </script>
</body>
</html>